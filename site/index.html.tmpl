<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>METAR Availability Timeline</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #334155;
      --ok: #15803d;
      --empty: #a16207;
      --error: #b91c1c;
      --missing: #94a3b8;
      --accent: #0369a1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top left, #e0f2fe 0%, var(--bg) 45%);
      min-height: 100vh;
    }
    a { color: #075985; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 16px; }
    .panel {
      background: var(--card);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
      margin-bottom: 10px;
    }
    h1 { margin-top: 0; font-size: 1.4rem; }
    h2 { margin: 0 0 6px 0; font-size: 1.05rem; }
    p { color: var(--muted); }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
    input, button {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 0.85rem;
    }
    button { background: var(--accent); border: none; color: #fff; cursor: pointer; }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 8px;
      margin: 10px 0;
    }
    .stat {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 8px;
    }
    .legend { display: flex; gap: 10px; color: var(--muted); font-size: 0.78rem; flex-wrap: wrap; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .small { font-size: 0.76rem; color: var(--muted); margin: 4px 0; }
    .grid-wrap { overflow-x: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    table { border-collapse: collapse; min-width: 780px; width: 100%; }
    th, td {
      border-bottom: 1px solid #e2e8f0;
      border-right: 1px solid #e2e8f0;
      padding: 4px 5px;
      text-align: center;
      font-size: 0.72rem;
      white-space: nowrap;
    }
    th.sticky, td.sticky {
      position: sticky;
      left: 0;
      background: #fff;
      z-index: 1;
      text-align: left;
      min-width: 100px;
    }
    th.date-head { font-weight: 500; color: #64748b; min-width: 52px; font-size: 0.62rem; }
    th.time-head { font-weight: 600; color: #475569; min-width: 52px; font-size: 0.68rem; }
    .cell {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin: 0 auto;
    }
    .ok { background: var(--ok); }
    .empty { background: var(--empty); }
    .error { background: var(--error); }
    .missing { background: var(--missing); }
    .station-block { margin-bottom: 10px; }
    .metar-item {
      display: block;
      padding: 6px 8px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 0.78rem;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>METAR Availability Timeline</h1>
      <p>Hourly checkpoints stacked by monitored station. <a href="admin.html">Admin</a></p>

      <div class="controls">
        <input id="limit" type="number" min="24" max="240" value="72" />
        <button id="refresh">Refresh</button>
      </div>

      <div class="summary" id="summary"></div>
      <div class="legend">
        <span><i class="dot" style="background: var(--ok)"></i>Run OK</span>
        <span><i class="dot" style="background: var(--empty)"></i>Run Empty</span>
        <span><i class="dot" style="background: var(--error)"></i>Run Error</span>
        <span><i class="dot" style="background: var(--ok)"></i>Station has METAR for checkpoint hour</span>
        <span><i class="dot" style="background: var(--missing)"></i>No METAR for checkpoint hour</span>
      </div>
      <p class="small" id="status"></p>
    </div>

    <div class="panel">
      <h2>Hourly Checkpoints (Stacked)</h2>
      <p class="small">X-axis shows UTC date/time for each checkpoint.</p>
      <div class="grid-wrap">
        <table id="checkpointTable"></table>
      </div>
    </div>

    <div class="panel">
      <h2>All Recent METAR Links</h2>
      <div id="allMetars"></div>
    </div>
  </div>

  <script>
    const API = "__API_URL__";
    const DEFAULT_STATION = "__DEFAULT_STATION__";

    function el(id) { return document.getElementById(id); }

    function fmtDate(iso) {
      const d = new Date(iso);
      const mm = String(d.getUTCMonth() + 1).padStart(2, "0");
      const dd = String(d.getUTCDate()).padStart(2, "0");
      return `${mm}/${dd}`;
    }

    function fmtTime(iso) {
      const d = new Date(iso);
      const hh = String(d.getUTCHours()).padStart(2, "0");
      return `${hh}:00Z`;
    }

    function hourKey(iso) {
      const d = new Date(iso);
      d.setUTCMinutes(0, 0, 0);
      return d.toISOString();
    }

    function metarLink(station) {
      return `https://aviationweather.gov/data/metar/?id=${encodeURIComponent(station)}&hours=3`;
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    function renderSummary(runs) {
      const ok = runs.filter(x => x.status === "ok").length;
      const empty = runs.filter(x => x.status === "empty").length;
      const error = runs.filter(x => x.status === "error").length;
      const availability = runs.length ? ((ok / runs.length) * 100).toFixed(1) : "0.0";

      el("summary").innerHTML = `
        <div class="stat"><strong>Total Checkpoints</strong><div>${runs.length}</div></div>
        <div class="stat"><strong>OK</strong><div>${ok}</div></div>
        <div class="stat"><strong>Empty</strong><div>${empty}</div></div>
        <div class="stat"><strong>Error</strong><div>${error}</div></div>
        <div class="stat"><strong>Availability</strong><div>${availability}%</div></div>
      `;
    }

    function buildMetarHourSet(items) {
      const set = new Set();
      (items || []).forEach(m => {
        if (m.observation_time) set.add(hourKey(m.observation_time));
      });
      return set;
    }

    function renderCheckpointTable(runs, stations, stationMetars) {
      const table = el("checkpointTable");
      const checkpoints = runs.map(r => r.checked_at_utc);

      let html = "<thead><tr><th class='sticky' rowspan='2'>Row</th>";
      checkpoints.forEach((cp, idx) => {
        const curr = fmtDate(cp);
        const prev = idx > 0 ? fmtDate(checkpoints[idx - 1]) : "";
        html += `<th class='date-head'>${curr !== prev ? curr : ""}</th>`;
      });
      html += "</tr><tr>";
      checkpoints.forEach(cp => { html += `<th class='time-head'>${fmtTime(cp)}</th>`; });
      html += "</tr></thead><tbody>";

      html += "<tr><td class='sticky'><strong>Collector Run</strong></td>";
      runs.forEach(run => {
        const cls = run.status === "ok" ? "ok" : run.status === "error" ? "error" : "empty";
        html += `<td title="${run.checked_at_utc} | ${run.status}"><div class="cell ${cls}"></div></td>`;
      });
      html += "</tr>";

      stations.forEach(station => {
        const sid = station.station_id;
        const hours = buildMetarHourSet(stationMetars[sid] || []);
        html += `<tr><td class="sticky"><strong>${sid}</strong></td>`;
        checkpoints.forEach(cp => {
          const present = hours.has(hourKey(cp));
          const cls = present ? "ok" : "missing";
          html += `<td title="${sid} @ ${fmtDate(cp)} ${fmtTime(cp)}"><div class="cell ${cls}"></div></td>`;
        });
        html += "</tr>";
      });

      html += "</tbody>";
      table.innerHTML = html;
    }

    function renderAllMetars(stations, stationMetars) {
      const box = el("allMetars");
      box.innerHTML = "";

      stations.forEach(station => {
        const sid = station.station_id;
        const items = (stationMetars[sid] || []).slice(-12).reverse();
        const section = document.createElement("div");
        section.className = "station-block";
        section.innerHTML = `<h3>${sid}</h3>`;

        items.forEach(m => {
          const a = document.createElement("a");
          a.className = "metar-item";
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.href = metarLink(sid);
          a.textContent = `${m.observation_time || ""} | ${m.flight_category || "N/A"} | ${m.raw_text || ""}`;
          section.appendChild(a);
        });

        if (!items.length) {
          const p = document.createElement("p");
          p.className = "small";
          p.textContent = "No recent METAR rows found.";
          section.appendChild(p);
        }

        box.appendChild(section);
      });
    }

    async function load() {
      const limit = Math.max(24, Math.min(Number(el("limit").value || 72), 240));
      el("status").textContent = "Loading...";

      try {
        const [runsRes, stationsRes] = await Promise.all([
          fetchJson(`${API}?type=runs&limit=${limit}`),
          fetchJson(`${API}?type=stations`)
        ]);

        const runs = runsRes.items || [];
        const stations = (stationsRes.items || []).filter(x => x.enabled !== false);
        if (!stations.length) stations.push({ station_id: DEFAULT_STATION, enabled: true });

        const metarResults = await Promise.all(
          stations.map(s => fetchJson(`${API}?type=metars&station=${encodeURIComponent(s.station_id)}&limit=${limit * 2}`))
        );
        const stationMetars = {};
        stations.forEach((s, idx) => { stationMetars[s.station_id] = metarResults[idx].items || []; });

        renderSummary(runs);
        renderCheckpointTable(runs, stations, stationMetars);
        renderAllMetars(stations, stationMetars);
        el("status").textContent = `Loaded ${runs.length} checkpoints and ${stations.length} stations.`;
      } catch (err) {
        el("status").textContent = `Failed to load data: ${err.message}`;
      }
    }

    el("refresh").addEventListener("click", load);
    load();
  </script>
</body>
</html>
