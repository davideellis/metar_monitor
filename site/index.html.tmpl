<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>METAR Availability Timeline</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #334155;
      --ok: #15803d;
      --empty: #a16207;
      --error: #b91c1c;
      --barbg: #cbd5e1;
      --accent: #0369a1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top left, #e0f2fe 0%, var(--bg) 45%);
      min-height: 100vh;
    }
    a { color: #075985; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px;
    }
    .panel {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(2, 6, 23, 0.08);
      margin-bottom: 14px;
    }
    h1 { margin-top: 0; font-size: 1.4rem; }
    h2 { margin-bottom: 8px; }
    p { color: var(--muted); }
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    input, button {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 0.95rem;
    }
    button {
      background: var(--accent);
      border: none;
      color: #fff;
      cursor: pointer;
    }
    .summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin: 16px 0;
    }
    .stat {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 10px;
    }
    .timeline {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(14px, 1fr));
      gap: 4px;
      margin: 18px 0;
    }
    .bar {
      height: 26px;
      border-radius: 4px;
      background: var(--barbg);
      transition: transform .1s ease;
    }
    .bar:hover { transform: translateY(-2px); }
    .ok { background: var(--ok); }
    .empty { background: var(--empty); }
    .error { background: var(--error); }
    .legend { display: flex; gap: 14px; color: var(--muted); font-size: 0.9rem; }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; }
    .small { font-size: 0.85rem; color: var(--muted); }
    .station-links, .metar-links {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .pill {
      display: inline-block;
      border: 1px solid #cbd5e1;
      background: #f8fafc;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 0.9rem;
    }
    .metar-item {
      display: block;
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>METAR Availability Timeline</h1>
      <p>Hourly collector run health and recent METAR links. <a href="admin.html">Admin</a></p>

      <div class="controls">
        <input id="station" placeholder="Station ID" value="__DEFAULT_STATION__" />
        <input id="limit" type="number" min="24" max="500" value="168" />
        <button id="refresh">Refresh</button>
      </div>

      <div class="summary" id="summary"></div>
      <div class="legend">
        <span><i class="dot" style="background: var(--ok)"></i>OK</span>
        <span><i class="dot" style="background: var(--empty)"></i>Empty</span>
        <span><i class="dot" style="background: var(--error)"></i>Error</span>
      </div>

      <div class="timeline" id="timeline"></div>
      <p class="small" id="status"></p>
    </div>

    <div class="panel">
      <h2>Monitored METARs</h2>
      <p class="small">Click a station to load its recent METAR links.</p>
      <div class="station-links" id="stations"></div>
    </div>

    <div class="panel">
      <h2>Recent METAR Links</h2>
      <p class="small" id="metarTitle"></p>
      <div class="metar-links" id="metars"></div>
    </div>
  </div>

  <script>
    const API = "__API_URL__";

    function el(id) { return document.getElementById(id); }

    function fmtRun(run) {
      const time = run.checked_at_utc || "unknown";
      return `${time} | ${run.status} | count=${run.metar_count ?? 0}`;
    }

    function metarLink(station, time) {
      return `https://aviationweather.gov/data/metar/?id=${encodeURIComponent(station)}&hours=3`;
    }

    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.json();
    }

    function renderRuns(runs) {
      const timeline = el("timeline");
      timeline.innerHTML = "";
      runs.forEach(run => {
        const bar = document.createElement("div");
        bar.className = `bar ${run.status || "empty"}`;
        bar.title = fmtRun(run);
        timeline.appendChild(bar);
      });

      const ok = runs.filter(x => x.status === "ok").length;
      const empty = runs.filter(x => x.status === "empty").length;
      const error = runs.filter(x => x.status === "error").length;
      const availability = runs.length ? ((ok / runs.length) * 100).toFixed(1) : "0.0";

      el("summary").innerHTML = `
        <div class="stat"><strong>Total Runs</strong><div>${runs.length}</div></div>
        <div class="stat"><strong>OK</strong><div>${ok}</div></div>
        <div class="stat"><strong>Empty</strong><div>${empty}</div></div>
        <div class="stat"><strong>Error</strong><div>${error}</div></div>
        <div class="stat"><strong>Availability</strong><div>${availability}%</div></div>
      `;
    }

    function renderStations(stations) {
      const box = el("stations");
      box.innerHTML = "";
      stations.forEach(s => {
        const a = document.createElement("a");
        a.className = "pill";
        a.href = "#";
        a.textContent = s.station_id;
        a.addEventListener("click", async (e) => {
          e.preventDefault();
          el("station").value = s.station_id;
          await loadMetarsForStation(s.station_id);
        });
        box.appendChild(a);
      });
    }

    function renderMetarLinks(station, items) {
      const list = el("metars");
      const title = el("metarTitle");
      list.innerHTML = "";
      title.textContent = `${station} (${items.length} shown)`;

      items.slice(-20).reverse().forEach(m => {
        const a = document.createElement("a");
        a.className = "metar-item";
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.href = metarLink(station, m.observation_time || "");
        a.textContent = `${m.observation_time} | ${m.flight_category || "N/A"} | ${m.raw_text || ""}`;
        list.appendChild(a);
      });
    }

    async function loadMetarsForStation(station) {
      const limit = Math.max(24, Math.min(Number(el("limit").value || 168), 500));
      const metars = await fetchJson(`${API}?type=metars&station=${encodeURIComponent(station)}&limit=${limit}`);
      renderMetarLinks(station, metars.items || []);
      return metars;
    }

    async function load() {
      const station = (el("station").value || "__DEFAULT_STATION__").toUpperCase();
      el("status").textContent = "Loading...";

      try {
        const [runs, stations, metars] = await Promise.all([
          fetchJson(`${API}?type=runs&limit=168`),
          fetchJson(`${API}?type=stations`),
          loadMetarsForStation(station)
        ]);
        renderRuns(runs.items || []);
        renderStations(stations.items || []);
        el("status").textContent = `Loaded ${runs.count || 0} runs, ${stations.count || 0} monitored stations, and ${metars.count || 0} METAR entries for ${station}.`;
      } catch (err) {
        el("status").textContent = `Failed to load data: ${err.message}`;
      }
    }

    el("refresh").addEventListener("click", load);
    load();
  </script>
</body>
</html>
