<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>METAR Admin</title>
  <style>
    body { font-family: "Segoe UI", Tahoma, sans-serif; margin: 0; background: #f8fafc; color: #0f172a; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; padding: 16px; margin-bottom: 16px; }
    input, select, button { padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; }
    button { background: #0f766e; color: #fff; border: 0; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; border-bottom: 1px solid #e2e8f0; padding: 10px 6px; font-size: 0.9rem; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: #475569; font-size: 0.9rem; }
    .row-actions { display: flex; gap: 6px; }
    .btn-secondary { background: #334155; }
    .btn-danger { background: #b91c1c; }
    .cell-input { width: 100%; min-width: 100px; padding: 6px; }
    .hidden { display: none; }
    .critical { border: 2px solid #dc2626; background: #fef2f2; }
    .critical h3 { color: #991b1b; margin-top: 0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>METAR Admin</h1>
    <p class="muted">Manage owners and station-level notification policy with username/password auth.</p>

    <div id="bootstrapCard" class="card critical">
      <h3>Critical: Initial Admin Bootstrap</h3>
      <p class="muted">Create the very first admin account. This section is hidden after bootstrap succeeds.</p>
      <div class="row" style="margin-top: 8px;">
        <input id="bootstrap_user" placeholder="Bootstrap username" />
        <input id="bootstrap_password" type="password" placeholder="Bootstrap password" />
        <button id="bootstrap" class="btn-danger">Bootstrap Admin</button>
      </div>
    </div>

    <div class="card">
      <h3>Admin Login & Reset</h3>
      <div class="row">
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button id="login">Login</button>
        <button id="logout" class="btn-secondary">Logout</button>
      </div>
      <div class="row" style="margin-top: 8px;">
        <input id="reset_user" placeholder="Reset username" />
        <button id="request_reset" class="btn-secondary">Request Reset</button>
        <input id="reset_code" placeholder="Reset code" style="width: 120px;" />
        <input id="new_password" type="password" placeholder="New password" />
        <button id="confirm_reset" class="btn-secondary">Confirm Reset</button>
      </div>
      <div class="row" style="margin-top: 8px;"><button id="load">Reload</button></div>
    </div>

    <div class="card">
      <h3>Add Owner</h3>
      <div class="row">
        <input id="owner_id" placeholder="owner-1" />
        <input id="topic_arn" placeholder="arn:aws:sns:us-east-1:123456789012:owner-topic" style="min-width: 460px;" />
        <button id="add_owner">Add Owner</button>
      </div>
      <table>
        <thead><tr><th>Owner ID</th><th>Topic ARN</th><th>Enabled</th><th>Action</th></tr></thead>
        <tbody id="owner_rows"></tbody>
      </table>
    </div>

    <div class="card">
      <h3>Add Station</h3>
      <div class="row">
        <input id="station" placeholder="KJFK" />
        <input id="station_owner_id" placeholder="owner-1" />
        <select id="notify_on">
          <option value="both">both</option>
          <option value="error">error</option>
          <option value="empty">empty</option>
        </select>
        <input id="cooldown" type="number" min="1" value="60" style="width: 100px;" />
        <button id="add_station">Add Station</button>
      </div>
      <table>
        <thead><tr><th>Station</th><th>Owner</th><th>Notify On</th><th>Cooldown (min)</th><th>Enabled</th><th>Alerts Enabled</th><th>Action</th></tr></thead>
        <tbody id="station_rows"></tbody>
      </table>
      <p id="status" class="muted"></p>
    </div>
  </div>

  <script>
    const API = "__ADMIN_API_URL__";
    const TOKEN_KEY = "metar_admin_session_token";
    function el(id) { return document.getElementById(id); }
    function token() { return localStorage.getItem(TOKEN_KEY) || ""; }
    function setToken(value) {
      if (value) localStorage.setItem(TOKEN_KEY, value);
      else localStorage.removeItem(TOKEN_KEY);
    }

    async function req(path, method, body) {
      const headers = { "content-type": "application/json" };
      if (token()) headers.Authorization = `Bearer ${token()}`;
      const res = await fetch(`${API}${path}`, {
        method,
        headers,
        body: body ? JSON.stringify(body) : undefined
      });
      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch (_) {}
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      return data;
    }

    async function loadBootstrapStatus() {
      try {
        const data = await req("?type=auth", "GET");
        el("bootstrapCard").classList.toggle("hidden", !!data.bootstrapped);
      } catch (_) {
        el("bootstrapCard").classList.remove("hidden");
      }
    }

    async function loadOwners() {
      const data = await req("?type=owners", "GET");
      const rows = el("owner_rows");
      rows.innerHTML = "";
      (data.items || []).forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${item.owner_id}</td><td>${item.topic_arn}</td><td>${item.alerts_enabled ? "true" : "false"}</td><td><button>Delete</button></td>`;
        tr.querySelector("button").addEventListener("click", async () => {
          await req(`owners/${encodeURIComponent(item.owner_id)}`, "DELETE");
          await loadAll();
        });
        rows.appendChild(tr);
      });
    }

    async function loadStations() {
      const data = await req("?type=stations", "GET");
      const rows = el("station_rows");
      rows.innerHTML = "";
      (data.items || []).forEach(item => {
        const tr = document.createElement("tr");
        const stationId = item.station_id;
        const ownerId = item.owner_id || "";
        const notifyOn = item.notify_on || "both";
        const cooldown = Number(item.cooldown_minutes || 60);
        const enabled = item.enabled !== false;
        const alertsEnabled = item.alerts_enabled !== false;

        tr.innerHTML = `
          <td><strong>${stationId}</strong></td>
          <td data-field="owner">${ownerId}</td>
          <td data-field="notify_on">${notifyOn}</td>
          <td data-field="cooldown">${cooldown}</td>
          <td data-field="enabled">${enabled ? "true" : "false"}</td>
          <td data-field="alerts_enabled">${alertsEnabled ? "true" : "false"}</td>
          <td class="row-actions">
            <button class="edit btn-secondary">Edit</button>
            <button class="save hidden">Save</button>
            <button class="cancel btn-secondary hidden">Cancel</button>
            <button class="delete btn-danger">Delete</button>
          </td>
        `;

        const editBtn = tr.querySelector(".edit");
        const saveBtn = tr.querySelector(".save");
        const cancelBtn = tr.querySelector(".cancel");
        const deleteBtn = tr.querySelector(".delete");

        const enterEditMode = () => {
          tr.querySelector('[data-field="owner"]').innerHTML = `<input class="cell-input" data-input="owner" value="${ownerId}" />`;
          tr.querySelector('[data-field="notify_on"]').innerHTML = `
            <select class="cell-input" data-input="notify_on">
              <option value="both" ${notifyOn === "both" ? "selected" : ""}>both</option>
              <option value="error" ${notifyOn === "error" ? "selected" : ""}>error</option>
              <option value="empty" ${notifyOn === "empty" ? "selected" : ""}>empty</option>
            </select>
          `;
          tr.querySelector('[data-field="cooldown"]').innerHTML = `<input class="cell-input" data-input="cooldown" type="number" min="1" value="${cooldown}" />`;
          tr.querySelector('[data-field="enabled"]').innerHTML = `<select class="cell-input" data-input="enabled"><option value="true" ${enabled ? "selected" : ""}>true</option><option value="false" ${!enabled ? "selected" : ""}>false</option></select>`;
          tr.querySelector('[data-field="alerts_enabled"]').innerHTML = `<select class="cell-input" data-input="alerts_enabled"><option value="true" ${alertsEnabled ? "selected" : ""}>true</option><option value="false" ${!alertsEnabled ? "selected" : ""}>false</option></select>`;
          editBtn.classList.add("hidden");
          saveBtn.classList.remove("hidden");
          cancelBtn.classList.remove("hidden");
        };

        editBtn.addEventListener("click", enterEditMode);
        cancelBtn.addEventListener("click", loadStations);
        saveBtn.addEventListener("click", async () => {
          const payload = {
            station_id: stationId,
            owner_id: tr.querySelector('[data-input="owner"]').value.trim(),
            notify_on: tr.querySelector('[data-input="notify_on"]').value,
            cooldown_minutes: Number(tr.querySelector('[data-input="cooldown"]').value || 60),
            enabled: tr.querySelector('[data-input="enabled"]').value === "true",
            alerts_enabled: tr.querySelector('[data-input="alerts_enabled"]').value === "true"
          };
          await req("?type=stations", "POST", payload);
          await loadStations();
          el("status").textContent = `Updated ${stationId}.`;
        });
        deleteBtn.addEventListener("click", async () => {
          await req(`stations/${stationId}`, "DELETE");
          await loadAll();
        });
        rows.appendChild(tr);
      });
      el("status").textContent = `Loaded ${data.count || 0} stations.`;
    }

    async function loadAll() {
      if (!token()) {
        el("status").textContent = "Not logged in.";
        return;
      }
      try {
        await Promise.all([loadOwners(), loadStations()]);
      } catch (err) {
        el("status").textContent = `Load failed: ${err.message}`;
      }
    }

    el("load").addEventListener("click", loadAll);

    el("login").addEventListener("click", async () => {
      try {
        const data = await req("", "POST", {
          action: "login",
          username: el("username").value.trim(),
          password: el("password").value
        });
        setToken(data.token || "");
        el("password").value = "";
        el("status").textContent = "Login successful.";
        await loadAll();
      } catch (err) {
        el("status").textContent = `Login failed: ${err.message}`;
      }
    });

    el("logout").addEventListener("click", () => {
      setToken("");
      el("owner_rows").innerHTML = "";
      el("station_rows").innerHTML = "";
      el("status").textContent = "Logged out.";
    });

    el("bootstrap").addEventListener("click", async () => {
      try {
        const data = await req("", "POST", {
          action: "bootstrap",
          username: el("bootstrap_user").value.trim(),
          password: el("bootstrap_password").value
        });
        setToken(data.token || "");
        el("bootstrap_password").value = "";
        el("status").textContent = "Bootstrap successful.";
        await loadBootstrapStatus();
        await loadAll();
      } catch (err) {
        el("status").textContent = `Bootstrap failed: ${err.message}`;
      }
    });

    el("request_reset").addEventListener("click", async () => {
      try {
        const data = await req("", "POST", {
          action: "request_reset",
          username: el("reset_user").value.trim()
        });
        el("status").textContent = `Reset code generated. Code: ${data.reset_code} (expires soon).`;
      } catch (err) {
        el("status").textContent = `Reset request failed: ${err.message}`;
      }
    });

    el("confirm_reset").addEventListener("click", async () => {
      try {
        await req("", "POST", {
          action: "confirm_reset",
          username: el("reset_user").value.trim(),
          reset_code: el("reset_code").value.trim(),
          new_password: el("new_password").value
        });
        el("new_password").value = "";
        el("status").textContent = "Password reset complete. You can log in now.";
      } catch (err) {
        el("status").textContent = `Reset failed: ${err.message}`;
      }
    });

    el("add_owner").addEventListener("click", async () => {
      try {
        await req("?type=owners", "POST", {
          owner_id: el("owner_id").value.trim(),
          topic_arn: el("topic_arn").value.trim(),
          alerts_enabled: true
        });
        el("owner_id").value = "";
        el("topic_arn").value = "";
        await loadAll();
      } catch (err) {
        el("status").textContent = `Add owner failed: ${err.message}`;
      }
    });

    el("add_station").addEventListener("click", async () => {
      try {
        await req("?type=stations", "POST", {
          station_id: (el("station").value || "").trim().toUpperCase(),
          owner_id: el("station_owner_id").value.trim(),
          notify_on: el("notify_on").value,
          cooldown_minutes: Number(el("cooldown").value || 60),
          enabled: true,
          alerts_enabled: true
        });
        el("station").value = "";
        await loadAll();
      } catch (err) {
        el("status").textContent = `Add station failed: ${err.message}`;
      }
    });

    loadBootstrapStatus();
    loadAll();
  </script>
</body>
</html>
